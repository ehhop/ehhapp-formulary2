{% extends 'layout.html' %}
{% block navbar%}
<li class="active"><a href="/medications">Medications</a></li>
                        <li class="inactive"><a href="/history">History</a></li>
                        <li class="inactive"><a href="/import">Import</a></li>
                         <li class="inactive"><a href="/export">Export</a></li>
{%endblock%}
{% block title %}Medications | ehhapp-formulary2{% endblock %}
{% macro increment(dct, key, inc=1)%}
    {% if dct.update({key: dct[key] + inc}) %} {% endif %}
{% endmacro %}
{% block body %}
	    <div class="page-header">
		    <h1>Medications</h1>
	    </div>
	    <form method="GET" action="/medications" class="form-inline">
	    	<label for="year">Year to analyze</label>
	    	<select name="year" class="form-control" onchange="this.form.submit()">
	    	 {% for y in range(2014,2019) %}
	    	 {% if y==year|int %}
			  <option value="{{y}}" selected="selected">{{y}}</option>
			 {% else %}
			   <option value="{{y}}">{{y}}</option>
			 {% endif %}
			 {% endfor %}
			 {% if year=="0" %}
			 	<option value="0" selected="selected">All</option>
			 {% else %}
			 	<option value="0">All</option>
			 {% endif %}
			</select>
	    </form>
	    <table class="table table-hover" id="activesort">
		<thead>
			<th> Name </th>
			<th> Category </th>
			<th> Start Price </th>
			<th> End Price </th>
			<th> % chg</th>
			<th> Spend total </th>
			<th> Bought </th>
			<th> Sold </th>
			<th> Scripts </th>
		</thead>
		<tbody>
		{% for med in medications %}
		<tr>
			<td> <a href="/medications/{{med.id}}?year={{year}}">{{ med.name }}</a></td>
			<td> {{med.category}} </td>
			<td> ${{ med.transactions[0].price | round(3) }}</td>
			<td> ${{ med.transactions[-1].price | round(3) }}</td>
			<td> {{(med.transactions[-1].price/med.transactions[0].price*100-100) | round(2)}}%</td>
			{% set spendcounter = {med.name:0} %}
			{% for m in med.transactions %}
				{{ increment(spendcounter,med.name,inc=m.qty|int*m.price|float) }}
			{% endfor %}
			<td> ${{spendcounter[med.name]|round(2)}}</td>
			{% set counter = {med.name:0} %}
			{% for m in med.transactions %}
				{% if m.qty|int > 0 %}
					{{ increment(counter,med.name,inc=m.qty|int) }}
				{% endif %}
			{% endfor %}
			<td> {{counter[med.name]}}</td>
			{% set returncounter = {med.name:0} %}
			{% for m in med.transactions %}
				{% if m.qty|int < 0 %}
					{{ increment(returncounter,med.name,inc=m.qty|int*-1) }}
				{% endif %}
			{% endfor %}
			<td> {{returncounter[med.name]}}</td>
			<td> {{med.transactions | length}} </td>
		</tr>
		{% endfor %}			
		</tbody>
	    </table>
	    {% if medications|length == 0 %}
	    <div class="alert alert-error">No medication records in DB.</div>
	    {% endif %}
	    </div>

{% endblock %}
